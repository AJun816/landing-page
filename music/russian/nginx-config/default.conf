# HTTP 自动跳转到 HTTPS
server {
    listen 80;
    server_name music.htgjai.com;  # 你的域名

    # 所有HTTP请求强制跳转至HTTPS
    return 301 https://$host$request_uri;
}

# HTTPS 主配置（包含原有反向代理功能）
server {
    listen 443 ssl;
    server_name music.htgjai.com;  # 你的域名

    # SSL证书配置（路径对应容器内挂载的证书目录）
    ssl_certificate /etc/nginx/certs/htgjai_com.crt;               # 服务器证书
    ssl_certificate_key /etc/nginx/certs/htgjai.key;               # 私钥文件（确保已放入certs目录）
    ssl_trusted_certificate /etc/nginx/certs/htgjai_com.ca-bundle; # 证书链

    # SSL安全配置（增强安全性）
    ssl_protocols TLSv1.2 TLSv1.3;                  # 支持的TLS版本
    ssl_prefer_server_ciphers on;                    # 优先使用服务器端加密套件
    ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH"; # 加密套件
    ssl_session_cache shared:SSL:10m;                # 会话缓存
    ssl_session_timeout 10m;                         # 会话超时时间

    # 通用反向代理配置（适用于所有页面）
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;  # 传递HTTPS协议标识
    proxy_connect_timeout 30s;
    proxy_read_timeout 60s;
    client_max_body_size 10M;  # 限制请求体大小

    # 1. Dreamy 风格页面：访问 /dreamy 路径
    location /dreamy/ {
        rewrite ^/dreamy/(.*)$ /$1 break;
        proxy_pass http://page-dreamy:80;
    }

    # 2. Passion 风格页面：访问 /passion 路径
    location /passion/ {
        rewrite ^/passion/(.*)$ /$1 break;
        proxy_pass http://page-passion:80;
    }

    # 3. Tradition 风格页面：访问 /tradition 路径
    location /tradition/ {
        rewrite ^/tradition/(.*)$ /$1 break;
        proxy_pass http://page-tradition:80;
    }

    # 4. Tranquility 风格页面：访问 /tranquility 路径
    location /tranquility/ {
        rewrite ^/tranquility/(.*)$ /$1 break;
        proxy_pass http://page-tranquility:80;
    }

    # 处理不带斜杠的路径（自动补全）
    location ~ ^/(dreamy|passion|tradition|tranquility)$ {
        return 301 $scheme://$host$request_uri/;
    }

    # 根路径默认跳转至 Dreamy 风格页面
    location / {
        return 302 /dreamy/;
    }

    # 404页面配置
    error_page 404 /404.html;
    location = /404.html {
        root /usr/share/nginx/html;
        internal;
    }
}
